<tool id="palmapper_wrapper" name="Map with PALMapper" version="0.4">
  <description></description>
  <command interpreter="python">
    palmapper_wrapper.py
    --paired=$singlePaired.sPaired
    --input1=$singlePaired.input1
    #if $singlePaired.sPaired == "paired":
       --input2=$singlePaired.input2
    #else:
       --input2="None"
    #end if
	--indexSource=$refIndexSource.indexSource
	#if $refIndexSource.indexSource=="bwa":
	    --genomeSource=$refGenomeSourceBwa.genomeSourceBwa
       #if $refGenomeSourceBwa.genomeSourceBwa == "history":
          --ref=$refGenomeSourceBwa.ownFileBwa
          --indexSettings="None"
       #else:
          --ref=$refGenomeSourceBwa.bwaIndices.value
          --indexSettings="None"
       #end if

	#else:
       --genomeSource=$refGenomeSourceArray.genomeSourceArray
       #if $refGenomeSourceArray.genomeSourceArray == "history":
          --ref=$refGenomeSourceArray.ownFileArray
          --indexSettings=$refGenomeSourceArray.indexParamsArray.index_settings
       #else:
          --ref=$refGenomeSourceArray.arrayIndices.value
          --indexSettings="None"
       #end if
       #if $refGenomeSourceArray.genomeSourceArray == "history" and $refGenomeSourceArray.indexParamsArray.index_settings == "index_full":
          --seedlength=$refGenomeSourceArray.indexParamsArray.seedlength
       #end if 
    #end if 

	--ss-pred=$splicesite.splicesite_use
	#if $splicesite.splicesite_use == "true":
       --acc $singlePaired.splicesite.accpred.extra_files_path
       --don $singlePaired.splicesite.donpred.extra_files_path
	#endif

    --format=$singlePaired.format
    --unspliced-output=$unspliced_output
    --spliced-output=$spliced_output
    --sam-output=$sam_output
    --params=$singlePaired.params.settings_type
    #if $singlePaired.params.settings_type == "full":
       --alignseedlength=$singlePaired.params.alignseedlength
       --maxmismatches=$singlePaired.params.maxmismatches
       --maxgaps=$singlePaired.params.maxgaps
       --maxedits=$singlePaired.params.maxedits
	   --seedhitcancel=$singlePaired.params.seedhitcancel
       --threads=$singlePaired.params.threads
       --reportall=$singlePaired.params.reportall
	   #if $singlePaired.params.reportall=="false":
    	  --topalignment=$singlePaired.params.topalignment
	   #else   
    	  --topalignment="None"
    #else
       --reportall="false"
       --maxmismatches="None"
       --maxgaps="None"
       --maxedits="None"
       --alignseedlength="None"
       --seedhitcancel="None"
       --topalignment="None"
       --threads="None"
    #end if
     --qpalma $singlePaired.condQpalmaParSource.qpalma_pars
     --qpalma-params=$singlePaired.qpalma_params.settings_type
    #if $singlePaired.qpalma_params.settings_type == "full":
       --mmtrigger=$singlePaired.qpalma_params.mmtrigger
       --gtrigger=$singlePaired.qpalma_params.gtrigger
       --maxalign=$singlePaired.qpalma_params.maxalign
       --aligntrigger=$singlePaired.qpalma_params.aligntrigger
       --alignshorttrigger=$singlePaired.qpalma_params.alignshorttrigger
       --aligncombinedtrigger=$singlePaired.qpalma_params.aligncombinedtrigger
       --maxintronlength=$singlePaired.qpalma_params.maxintronlength
       --maxintronnum=$singlePaired.qpalma_params.maxintronnum
	   --qmm=$singlePaired.qpalma_params.qmm
       --clustertol=$singlePaired.qpalma_params.clustertol
       --qpalma-use-map-max-len=$singlePaired.qpalma_params.maxmapextension
       --report_ss=$singlePaired.qpalma_params.report_ss
       --reportmappedread=$singlePaired.qpalma_params.reportmappedread
       --reportsplicedread=$singlePaired.qpalma_params.reportsplicedread
    #else
	   --mmtrigger="None"
       --gtrigger="None"
       --maxalign="None"
       --aligntrigger="None"
       --alignshorttrigger="None"
       --aligncombinedtrigger="None"
       --maxintronlength="None"
       --maxintronnum="None"
	   --qmm="None"
       --clustertol="None"
       --qpalma-use-map-max-len="None"
       --report_ss="None"
       --reportmappedread="None"
       --reportsplicedread="None"
    #end if > $logfile
  </command>

  <tests>
    <test>
      <param name="genomeSource" value="history" />
      <param name="ownFile" value="c_elegans.WS200.dna.fa" ftype="fasta" />
      <param name="index_settings" value="index_pre_set" />
      <param name="sPaired" value="single" />
      <param name="input1" value="palmapper_reads.fastqsanger" ftype="fastqsanger" />
  	  <param name="format" value="sam" />
      <param name="settings_type" value="pre_set" />
  	  <param name="qpalmaParSource" value="history" />
	  <param name="qpalma_pars" value="palmapper_parameters.qpalma" />
  	  <param name="settings_type" value="pre_set" />
  	  <output name="sam_output" value="palmapper_mapped.sam" />
    </test>
  </tests>


  <inputs>
	<conditional name="refIndexSource">
      <param name="indexSource" type="select" label="Will you use bwa index or GenomeMapper index?" help="GenomeMapper index needs more space.">
        <option value="array">GenomeMapper index</option>
        <option value="bwa">BWA index</option>
      </param>
	  <when value="array">
		<conditional name="refGenomeSourceArray">
		<param name="genomeSourceArray" type="select" label="Will you select a reference genome from your history or use a built-in index?" help="Built-ins were indexed using default options">
          <option value="indexed">Use a built-in index</option>
          <option value="history">Use one from the history</option>
		</param>
		<when value="indexed">
    	  <param name="arrayIndices" type="select" label="Select a reference genome" help="if your genome of interest is not listed - contact Galaxy team">
  	  		<options from_file="genomemapper_indices.loc">
  	    	  <column name="value" index="1" />
  	    	  <column name="name" index="0" />
  	  		</options>
  		  </param>
		</when>
		<when value="history">
          <param name="ownFileArray" type="data" format="fasta" label="Select a reference genome" />
          <conditional name="indexParams">
			<param name="index_settings" type="select" label="Choose whether to use default options for building indices or to set your own">
              <option value="index_pre_set">Default</option>
              <option value="index_full">Set your own</option>
			</param> 
			<when value="index_pre_set" />
			<when value="index_full">
              <param name="seedlength" type="integer" value="12" label="Index seed length" help="Integer between 8 and 13." />
			</when> <!-- index_full -->
          </conditional>
		</when>
		</conditional> <!-- refGenomeSource -->
	  </when>
	  <when value="bwa">
		<conditional name="refGenomeSourceBwa">
		<param name="genomeSourceBwa" type="select" label="Will you select a reference genome from your history or use a built-in index?" help="Built-ins were indexed using default options">
          <option value="indexed">Use a built-in index</option>
          <option value="history">Use one from the history</option>
		</param>
		<when value="indexed">
    	  <param name="bwaIndices" type="select" label="Select a reference genome" help="if your genome of interest is not listed - contact Galaxy team">
  	  		<options from_file="bwa_index.loc">
  	    	  <column name="value" index="1" />
  	    	  <column name="name" index="0" />
  	  		</options>
  		  </param>
		</when>
		<when value="history">
          <param name="ownFileBwa" type="data" format="fasta" label="Select a reference genome" />
		</when>
		</conditional> <!-- refGenomeSource -->
	  </when>
	  </conditional> <!-- refIndexSource -->
    <conditional name="singlePaired">
      <param name="sPaired" type="select" label="Is this library mate-paired?">
        <option value="single">Single-end</option>
        <!-- <option value="paired">Paired-end</option> -->
      </param>
      <when value="single">
        <param name="input1" type="data" format="fastqsanger" label="FASTQ file" help="Must have Sanger-scaled quality values with ASCII offset 33"/>
		<param name="format" type="select" label="Output format">
	      <option value="sam">SAM format</option>
	      <option value="bedx">Extended BED format</option>
	    </param> 
        <conditional name="params">
          <param name="settings_type" type="select" label="Settings to use" help="For most mapping needs use Commonly used settings. If you want full control use Full parameter list">
	    	<option value="pre_set">Commonly used</option>
   	    	<option value="full">Full parameter list</option>
	  	  </param>
          <when value="pre_set" />
          <when value="full">
            <param name="alignseedlength" type="integer" value="18" label="Minimal considered hit length (-l)" help="Integer not smaller than the index seed length." />
            <param name="maxmismatches" type="integer" value="3" label="Maximal number of mismatches (-M)" />  
            <param name="maxgaps" type="integer" value="1" label="Maximal number of gaps (-G)" />  
		    <param name="maxedits" type="integer" value="3" label="Maximal number of edit operations (-E)" />  
        	<param name="seedhitcancel" type="integer" value="10000" label="Maximal number of seed hits before seed is ignored" />  
        	<param name="threads" type="integer" value="10" label="Maximal number of threads" />  
        	<param name="topalignment" type="integer" value="10" label="Number of top scoring alignments to report (-z)" help="A non-zero digit." />  
			<param name="reportall" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Report all alignments (-a)" />
          </when> <!-- full -->
		</conditional> <!-- params -->
        <conditional name="splicesite">
		  <param name="splicesite_use" type="select" label="Will you want to use splice site predictions for running PALMapper?" help="If you use splice site predictions, please choose a QPALMA parameter file which was obtained by training QPALMA with the same splice site predictions. Reciprocally, if you don't use splice site predictions, use a QPALMA parameter file which was obtained by training QPALMA without any splice site predictions.">
	    	<option value="true">Use of splice site predictions</option>
   	    	<option value="false">No use of splice site predictions</option>
	  	  </param>
          <when value="false" />
          <when value="true">
			<param format="spf" name="accpred" type="data" label="Acceptor splice site predictions in SPF format" help="The prediction file contains a signal prediction score for each candidate acceptor splice site. It can be generated with 'SignalPredict' (see mGene.web modules)."/>
			<param format="spf" name="donpred" type="data" label="Donor splice site predictions in SPF format" help="The prediction file contains a signal prediction score for each candidate donor splice site. It can be generated with 'SignalPredict' (see mGene.web modules)."/>
          </when> <!-- ss_use -->
		</conditional> <!-- splicesite -->
		<conditional name="condQpalmaParSource">
		  <param name="qpalmaParSource" type="select" label="Will you select a built-in QPALMA parameter file or one from the history?" >
			<option value="built-in">Use a built-in QPALMA parameter file</option>
			<option value="history">Use one from the history</option>
		  </param>
		  <when value="built-in">
			<param name="qpalma_pars" type="select" label="Select QPALMA parameter file" help="Parameters are obtaind by training QPALMA. Currently, we only offer a set of pretrained QPALMA models.">
  	      	  <options from_file="qpalma_parameters.loc">
				<column name="value" index="1" />
				<column name="name" index="0" />
			  </options>
  	    	</param>
		  </when>
		  <when value="history">
			<param format="qpalmaparam" name="qpalma_pars" type="data" label="QPALMA parameters" help="The parameter file can be obtained by training QPALMA."/>
		  </when>
		</conditional> <!-- condQpalmaParSource -->
		
		<conditional name="qpalma_params">
		  <param name="settings_type" type="select" label="QPALMA settings to use" help="For most mapping needs use Commonly used settings. If you want full control use Full parameter list">
			<option value="pre_set">Commonly used</option>
			<option value="full">Full parameter list</option>
		  </param>
		  <when value="pre_set" />
		  <when value="full">
			<param name="mmtrigger" type="integer" value="3" label="Threshold to trigger spliced alignments (mismatches)" help="Trigger spliced alignment, if unspliced alignment has at least this many mismatches." />  
			<param name="gtrigger" type="integer" value="0" label="Threshold to trigger spliced alignments (gaps)" help="Trigger spliced alignment, if unspliced alignment has at least this many gaps." />  
		    <!-- <param name="filter_ss_tophit" type="float" value="0.9" label="QPALMA splice site trigger" help="Trigger spliced alignments, if read covers top percentile splice site (between 0 and 1)." />   -->
			<param name="maxalign" type="integer" value="10" label="Maximal number of spliced alignments per read (-SA)" />  
			<param name="aligntrigger" type="integer" value="20" label="Minimal length of long hit (-L)" help="Integer not smaller than the index seed length." />
			<param name="alignshorttrigger" type="integer" value="15" label="Minimal length of short hit (-K)" help="Integer not smaller than the index seed length." />
			<param name="aligncombinedtrigger" type="integer" value="20" label="Minimal combined matches (-C)" help="Integer not smaller than the index seed length." />
			<param name="maxintronlength" type="integer" value="10000" label="Maximal intron length (-I)" />  
			<param name="maxintronnum" type="integer" value="2" label="Maximal number of introns (-NI)" />  
			<param name="qmm" type="integer" value="5" label="Minimal number of matches required for identifying a splice site (-QMM)" />  
			<param name="clustertol" type="integer" value="10" label="Distance in nt to tolerate between hit and existing hit cluster (-CT)" />  
			<param name="maxmapextension" type="integer" value="5000" label="Up and downstream limit of map extension (-qpalma-use-map-max-len)" />  
			<param name="report_ss" type="float" value="0.9" help="Splice site-based alignment regions" label="Use splice site for determining alignment regions (between 0 and 1 for filtering splice sites by their score)." />  
	    	<param name="reportmappedread" type="select" label="Use mapped unspliced reads for determining alignment regions." >
			  <option value="True">true</option>
			  <option value="False">false</option>
			</param>
			<param name="reportsplicedread" type="select" label="Use mapped spliced reads for determining alignment regions" >
			  <option value="True">true</option>
			  <option value="False">false</option>
			</param>
		  </when> <!-- full -->
		</conditional> <!-- qpalma_params -->
	  </when> <!-- single -->
    </conditional> <!-- singlePaired -->
    <!-- <param name="suppressHeader" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Suppress the header in the output SAM file" help="GenomeMapper produces SAM with several lines of header information" /> -->
  </inputs>
  <outputs>
	<data format="bed" name="unspliced_output" label="PALMapper unspliced alignment file in BED format" >
	  <filter>singlePaired['format'] == "bedx"</filter> 
	</data>
    <data format="bed" name="spliced_output" label="PALMapper spliced alignment file in BED format" >
	  <filter>singlePaired['format'] == "bedx"</filter> 
	</data>
	<data format="sam" name="sam_output" label="PALMapper spliced-unspliced alignment file in SAM format" >
	  <filter>singlePaired['format'] == "sam"</filter> 
	</data>
    <data format="txt" name="logfile" label="PALMapper LOG" />
  </outputs>
  <help>


**PALMapper overview**

PALMapper_ is the the fusion of the short read mapper GenomeMapper_ [1]_ and the short read aligner QPALMA_ [2]_ and is an easy-to-use and flexible tool to accurately and efficiently align both transcriptome reads (spliced and unspliced) from RNA-seq experiments against a reference genome. PALMapper is able to take advantage of read quality information by using the efficient training algorithm of QPALMA (see `Train QPALMA` in NGS:QPALMA tools section). It is additionally able to benefit from computational splice site predictions to improve the alignment accuracy.

.. _QPALMA: http://www.fml.tuebingen.mpg.de/raetsch/suppl/qpalma
.. _PALMapper: http://www.fml.tuebingen.mpg.de/raetsch/suppl/palmapper
.. _GenomeMapper: http://www.1001genomes.org/downloads/genomemapper.html

.. class:: warningmark

Running this tool with default parameters will probably not give you meaningful results. A way to deal with this is to **understand** the parameters by carefully reading `PALMapper tutorial`_ [3]_ and experimenting. Fortunately, Galaxy makes experimenting easy.


------

**Inputs**

* Genome sequence in FASTA format
* Read data to align in Sanger FASTQ format
* QPALMA parameter file (Use a precomputed QPALMA parameter file of compute it by training QPALMA)


------

**Outputs**

* Alignment file (in SAM or BEDx format), which stores all alignments of reads for which an alignment satisfying the specified criteria has been found.

-------

**PALMapper settings**

All of the options have a default value. You can change any of them. Most of the options in PALMapper have been implemented here. For more information, please read `PALMapper tutorial`_ [3]_.

.. _`PALMapper tutorial`: http://www.fml.tuebingen.mpg.de/raetsch/suppl/palmapper/tutorial

**References**

.. [1] Schneeberger, K. et al., Simultaneous alignment of short reads against multiple genomes, Genome Biol. 10 (9):R98, 2009.
.. [2] De Bona, F. et al., Optimal Spliced Alignments of Short Sequence Reads, ECCB08/Bioinformatics, 24 (16):i174, 2008.
.. [3] Jean, G., Kahles, A., Sreedharan, V.T., De Bona, F., Raetsch, G., RNA-Seq Read Alignments with PALMapper, Curr. Protoc. Bioinform., 32:11.6.1-11.6.38, 2010.


  </help>
</tool>
